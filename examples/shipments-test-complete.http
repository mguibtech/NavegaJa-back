### ========================================
### ðŸ§ª TESTES COMPLETOS - Sistema de Encomendas
### ========================================
###
### Execute em ordem para testar todo o fluxo!
###
### ========================================

### VariÃ¡veis
@baseUrl = http://localhost:3000
@token = SEU_TOKEN_AQUI
@tripId = UUID_DE_UMA_VIAGEM


### ========================================
### 0ï¸âƒ£ PREPARAÃ‡ÃƒO - Login
### ========================================

### Fazer login para obter token
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "cpf": "12345678900",
  "password": "senha123"
}

### Copie o accessToken da resposta e cole na variÃ¡vel @token acima


### ========================================
### 1ï¸âƒ£ TESTE: Gerar Presigned URLs (S3)
### ========================================

### Gerar 3 URLs para upload
POST {{baseUrl}}/shipments/upload/presigned-urls
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "count": 3
}

### âœ… Esperado:
### - Status 200
### - Response com 3 URLs (uploadUrl, publicUrl, key)
### - expiresIn: 300


### ========================================
### 2ï¸âƒ£ TESTE: Calcular PreÃ§o (com weight)
### ========================================

### Teste com "weight" (formato frontend)
POST {{baseUrl}}/shipments/calculate-price
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "tripId": "{{tripId}}",
  "weight": 2.5,
  "dimensions": {
    "length": 30,
    "width": 20,
    "height": 15
  },
  "couponCode": "FRETE10"
}

### âœ… Esperado:
### - Status 200
### - actualWeight: 2.5
### - volumetricWeight: 1.5
### - chargedWeight: 2.5 (maior entre os dois)
### - couponDiscount > 0 (se cupom existir)
### - finalPrice < basePrice


### ========================================
### 3ï¸âƒ£ TESTE: Calcular PreÃ§o (com weightKg)
### ========================================

### Teste com "weightKg" (formato backend - deve funcionar!)
POST {{baseUrl}}/shipments/calculate-price
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "tripId": "{{tripId}}",
  "weightKg": 2.5,
  "length": 30,
  "width": 20,
  "height": 15,
  "couponCode": "FRETE10"
}

### âœ… Esperado:
### - Mesmo resultado do teste anterior
### - Backend aceita AMBOS os formatos!


### ========================================
### 4ï¸âƒ£ TESTE: Criar Encomenda (JSON)
### ========================================

### Criar encomenda com JSON puro
POST {{baseUrl}}/shipments
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "tripId": "{{tripId}}",
  "description": "Teste de encomenda via JSON",
  "weightKg": 2.5,
  "length": 30,
  "width": 20,
  "height": 15,
  "photos": [
    "https://via.placeholder.com/300",
    "https://via.placeholder.com/400"
  ],
  "recipientName": "JoÃ£o da Silva Teste",
  "recipientPhone": "11987654321",
  "recipientAddress": "Rua Teste, 123 - Centro, SÃ£o Paulo-SP, CEP 01000-000",
  "paymentMethod": "pix",
  "couponCode": "FRETE10"
}

### âœ… Esperado:
### - Status 201
### - Response COM aliases:
###   {
###     "id": "uuid",
###     "trackingCode": "NJ2026000001",
###     "qrCode": "data:image/png;base64...",
###     "weightKg": 2.5,
###     "weight": 2.5,           â† Alias
###     "totalPrice": X,
###     "price": X,              â† Alias
###     "length": 30,
###     "width": 20,
###     "height": 15,
###     "dimensions": {          â† Alias
###       "length": 30,
###       "width": 20,
###       "height": 15
###     },
###     "status": "pending",
###     "photos": ["https://..."],
###     "createdAt": "..."
###   }

### ðŸ“‹ Copie o "id" da resposta para usar nos prÃ³ximos testes
@shipmentId = UUID_DA_ENCOMENDA_CRIADA
@trackingCode = TRACKING_CODE_GERADO


### ========================================
### 5ï¸âƒ£ TESTE: Listar Minhas Encomendas
### ========================================

### Listar todas as encomendas do usuÃ¡rio
GET {{baseUrl}}/shipments/my-shipments
Authorization: Bearer {{token}}

### âœ… Esperado:
### - Status 200
### - Array com encomendas
### - Cada item COM aliases (weight, price, dimensions)
### - Ordenado por createdAt DESC (mais recente primeiro)


### ========================================
### 6ï¸âƒ£ TESTE: Buscar Encomenda por ID
### ========================================

### Buscar detalhes completos
GET {{baseUrl}}/shipments/{{shipmentId}}
Authorization: Bearer {{token}}

### âœ… Esperado:
### - Status 200
### - Encomenda completa COM aliases
### - Relations populadas (trip, sender)
### - QR Code presente


### ========================================
### 7ï¸âƒ£ TESTE: Timeline de Eventos
### ========================================

### Buscar timeline da encomenda
GET {{baseUrl}}/shipments/{{shipmentId}}/timeline
Authorization: Bearer {{token}}

### âœ… Esperado:
### - Status 200
### - Array com pelo menos 1 evento:
###   {
###     "id": "uuid",
###     "status": "pending",
###     "description": "Encomenda criada...",
###     "createdAt": "...",
###     "timestamp": "..."      â† Alias para createdAt
###   }


### ========================================
### 8ï¸âƒ£ TESTE: Rastreamento PÃºblico (sem auth)
### ========================================

### Rastrear por cÃ³digo (SEM Authorization!)
GET {{baseUrl}}/shipments/track/{{trackingCode}}

### âœ… Esperado:
### - Status 200
### - {
###     "shipment": { ...com aliases },
###     "timeline": [ ...com timestamp ]
###   }


### ========================================
### 9ï¸âƒ£ TESTE: Criar AvaliaÃ§Ã£o
### ========================================

### ATENÃ‡ÃƒO: SÃ³ funciona se status = "delivered"
### VocÃª pode mudar o status manualmente no banco ou pular este teste

### Criar avaliaÃ§Ã£o
# POST {{baseUrl}}/shipments/reviews
# Authorization: Bearer {{token}}
# Content-Type: application/json
#
# {
#   "shipmentId": "{{shipmentId}}",
#   "rating": 5,
#   "deliveryQuality": 5,
#   "timeliness": 4,
#   "comment": "Teste de avaliaÃ§Ã£o - entrega perfeita!"
# }

### âœ… Esperado (se status = delivered):
### - Status 201
### - Review criada

### âŒ Esperado (se status != delivered):
### - Status 400
### - Error: "SÃ³ Ã© possÃ­vel avaliar encomendas entregues"


### ========================================
### ðŸ”Ÿ TESTE: Buscar AvaliaÃ§Ã£o
### ========================================

### Buscar avaliaÃ§Ã£o da encomenda
GET {{baseUrl}}/shipments/{{shipmentId}}/review
Authorization: Bearer {{token}}

### âœ… Esperado (se avaliaÃ§Ã£o existe):
### - Status 200
### - Review encontrada

### âœ… Esperado (se nÃ£o tem avaliaÃ§Ã£o):
### - Status 200
### - null


### ========================================
### 1ï¸âƒ£1ï¸âƒ£ TESTE: Cancelar Encomenda
### ========================================

### Cancelar encomenda
POST {{baseUrl}}/shipments/{{shipmentId}}/cancel
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "reason": "Teste de cancelamento"
}

### âœ… Esperado:
### - Status 200
### - Encomenda com status "cancelled"


### ========================================
### ðŸ“Š RESUMO DOS TESTES
### ========================================
###
### Execute nesta ordem:
###
### 1. âœ… Login (obter token)
### 2. âœ… Gerar presigned URLs
### 3. âœ… Calcular preÃ§o (weight)
### 4. âœ… Calcular preÃ§o (weightKg)
### 5. âœ… Criar encomenda
### 6. âœ… Listar encomendas
### 7. âœ… Buscar por ID
### 8. âœ… Timeline
### 9. âœ… Rastreamento pÃºblico
### 10. â© Criar avaliaÃ§Ã£o (skip se nÃ£o delivered)
### 11. âœ… Buscar avaliaÃ§Ã£o
### 12. âœ… Cancelar encomenda
###
### ========================================


### ========================================
### ðŸ”§ TESTES ADICIONAIS
### ========================================

### Teste: Erro ao criar encomenda sem recipientName
POST {{baseUrl}}/shipments
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "tripId": "{{tripId}}",
  "description": "Teste sem recipientName",
  "weightKg": 2.5,
  "recipientPhone": "11987654321",
  "recipientAddress": "Rua Teste, 123",
  "paymentMethod": "pix",
  "photos": ["https://via.placeholder.com/300"]
}

### âœ… Esperado:
### - Status 400
### - Error: ValidaÃ§Ã£o falhou


### Teste: Erro ao calcular preÃ§o com peso invÃ¡lido
POST {{baseUrl}}/shipments/calculate-price
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "tripId": "{{tripId}}",
  "weight": 100
}

### âœ… Esperado:
### - Status 400
### - Error: Peso deve estar entre 0.1kg e 50kg


### Teste: Erro ao buscar encomenda inexistente
GET {{baseUrl}}/shipments/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{token}}

### âœ… Esperado:
### - Status 404
### - Error: Encomenda nÃ£o encontrada


### ========================================
### âœ… FIM DOS TESTES
### ========================================
